const TelegramBot = require('node-telegram-bot-api');
const express = require('express'); // Ð”Ð»Ñ HTTP-ÑÐµÑ€Ð²ÐµÑ€Ð°
require('dotenv').config();

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¾ÐºÐµÐ½Ð°
if (!process.env.TELEGRAM_BOT_TOKEN) {
  throw new Error('âŒ TELEGRAM_BOT_TOKEN Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½ Ð² .env');
}

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð°
let bot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, {
  polling: {
    interval: 1000,
    autoStart: true,
    params: {
      timeout: 10,
    },
  },
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const webAppUrl = process.env.WEB_APP_URL || 'https://adeviceminishopdemo.vercel.app ';

  const options = {
    reply_markup: {
      inline_keyboard: [[{
        text: 'ðŸ›ï¸ ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½',
        web_app: { url: webAppUrl }
      }]]
    }
  };

  bot.sendMessage(chatId, 'Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² A-Device! ðŸ›ï¸\n\n' +
    'ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð½Ð°Ñˆ Ð²ÐµÐ±-Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½:', options)
    .catch(err => console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', err.message));
});

// HTTP-ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸
const app = express();
const PORT = process.env.PORT || 3000;

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°
app.get('/health', (req, res) => {
  res.status(200).send('OK'); // ÐžÑ‚Ð²ÐµÑ‚ Ð½Ð° Ð·Ð°Ð¿Ñ€Ð¾Ñ UptimeRobot
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
app.listen(PORT, () => {
  console.log(`ðŸš€ HTTP-ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.on('polling_error', (error) => {
  console.error('âŒ Polling error:', error.message);
  restartBot();
});

process.on('uncaughtException', (err) => {
  console.error('âŒ Uncaught Exception:', err.message);
  restartBot();
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('âŒ Unhandled Rejection:', reason.message);
  restartBot();
});

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð¾Ñ‚Ð°
function restartBot() {
  console.log('ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð° Ñ‡ÐµÑ€ÐµÐ· 5 ÑÐµÐºÑƒÐ½Ð´...');
  bot.stopPolling(); // ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ polling

  setTimeout(() => {
    bot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, {
      polling: {
        interval: 1000,
        autoStart: true,
        params: {
          timeout: 10,
        },
      },
    });
    console.log('âœ… Ð‘Ð¾Ñ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½');
  }, 5000);
}